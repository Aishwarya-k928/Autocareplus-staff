<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const db = getFirestore(initializeApp({
        apiKey: "AIzaSyD9cPmUCMEtT7XukcAxmeS50jKh1A2f31Q", // Use your actual API Key
        projectId: "auto-care-plus-e7fdf"
    }));

    let data = [];
    let isHistory = false;
    const STAGES = ["NEW", "SERVICING", "READY", "COLLECTED"];

    // 1. IMPROVED TIMING LOGIC
    // Added fallback for when serverTimestamp is null (during local latency)
    function getTiming(createdAt, collectedAt, stage) {
        const now = new Date();
        const start = createdAt ? createdAt.toDate() : now; 
        const diffMins = Math.floor((now - start) / 60000);
        
        let isArchived = false;
        if (stage === "COLLECTED" && collectedAt) {
            const collectTime = collectedAt.toDate ? collectedAt.toDate() : now;
            if ((now - collectTime) / 60000 > 60) isArchived = true;
        }

        return {
            text: diffMins >= 60 ? `${Math.floor(diffMins/60)}h ${diffMins%60}m` : `${diffMins}m`,
            isDelayed: diffMins >= 360, // 6 Hours
            isArchived: isArchived
        };
    }

    // 2. RECTIFIED LISTEN FUNCTION
    // Added { includeMetadataChanges: true } to solve "not reflecting" issue
    function listen() {
        const q = query(collection(db, "jobs"), orderBy("createdAt", "desc"));
        
        onSnapshot(q, { includeMetadataChanges: true }, (snapshot) => {
            data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            draw();
            
            // Helpful for debugging: check console to see if data arrived
            console.log("Data synced. Count:", data.length, "From cache:", snapshot.metadata.fromCache);
        }, (error) => {
            console.error("Firestore Error:", error);
            alert("Connection error. Please refresh.");
        });

        // Force a UI refresh every minute for the timers
        setInterval(draw, 60000);
    }

    // 3. RECTIFIED UI DRAW
    window.draw = () => {
        const searchTerm = document.getElementById('search').value.toLowerCase();
        const histCont = document.getElementById('historyList');
        if(isHistory) histCont.innerHTML = "";

        STAGES.forEach(s => {
            const lane = document.getElementById(`lane-${s}`); 
            if(lane) lane.innerHTML = "";
            
            // Filter and Sort (Priority first)
            const filtered = data.filter(j => 
                (j.status || "NEW").toUpperCase() === s && 
                (j.vehicleNumber || "").toLowerCase().includes(searchTerm)
            ).sort((a, b) => (b.isPriority ? 1 : 0) - (a.isPriority ? 1 : 0));

            filtered.forEach(job => {
                const time = getTiming(job.createdAt, job.collectedAt, s);
                
                if (time.isArchived && !isHistory) return;
                if (!time.isArchived && isHistory) return;

                const card = document.createElement('div');
                card.className = `vehicle-card ${job.isPriority ? 'high-prio' : ''} ${time.isDelayed ? 'delayed' : ''}`;
                card.onclick = () => openN(job.id, job.vehicleNumber, job.notes);
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <span class="reg-tag">REG: ${job.vehicleNumber}</span>
                        <span class="duration-tag" style="color:${time.isDelayed ? 'var(--critical)' : 'inherit'}">${time.text}</span>
                    </div>
                    <h3 style="margin:8px 0 2px 0; font-size:17px; font-weight:700;">${job.customerName}</h3>
                    <div style="font-size:11px; opacity:0.6; margin-bottom:10px;">${job.serviceType}</div>
                    
                    <div class="card-footer">
                        <button class="ctrl-btn" onclick="move(event, '${job.id}', '${s}', -1)" ${s==='NEW'?'disabled':''}>←</button>
                        <button class="ctrl-btn prio-toggle ${job.isPriority ? 'active' : ''}" 
                                onclick="setPriority(event, '${job.id}', ${job.isPriority || false})">
                                ${job.isPriority ? '★ Priority' : '☆ Normal'}
                        </button>
                        <button class="ctrl-btn" onclick="move(event, '${job.id}', '${s}', 1)" ${s==='COLLECTED'?'disabled':''}>→</button>
                    </div>
                `;
                
                if(isHistory) histCont.appendChild(card); 
                else if(lane) lane.appendChild(card);
            });
        });
    };

    // ... (Keep existing move/setPriority/verifyAdmin functions) ...

    listen();
</script>
