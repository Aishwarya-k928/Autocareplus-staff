<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AutoCare Plus | Staff Terminal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #00d2ff;
            --glass: rgba(10, 15, 28, 0.96);
            --border: rgba(255, 255, 255, 0.12);
            --bg: #020617;
            --new: #3b82f6;
            --servicing: #f59e0b;
            --ready: #10b981;
            --collected: #64748b;
            --priority: #39ff14; /* Neon Green */
            --critical: #ff3131; /* Bright Red */
        }

        body { margin: 0; background: var(--bg); color: white; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; }
        
        .header { 
            padding: 20px 30px; border-bottom: 1px solid var(--border); 
            background: rgba(2, 6, 23, 0.9); display: flex; justify-content: space-between; align-items: center;
        }

        .workshop-floor {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 20px; padding: 20px; height: calc(100vh - 90px); overflow-x: auto;
        }

        .lane { background: rgba(255,255,255,0.01); border-radius: 20px; display: flex; flex-direction: column; min-width: 300px; border: 1px solid var(--border); }
        .lane-head { padding: 15px 20px; border-bottom: 1px solid var(--border); font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .lane-body { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

        /* --- UPDATED VEHICLE CARD --- */
        .vehicle-card { 
            background: var(--glass); border: 1px solid var(--border); border-radius: 18px; 
            padding: 20px; position: relative; transition: 0.3s; cursor: pointer;
        }
        
        /* Priority Styling */
        .vehicle-card.high-prio { border: 2px solid var(--priority); box-shadow: 0 0 15px rgba(57, 255, 20, 0.2); }
        
        /* Delay Styling (6+ Hours) */
        .vehicle-card.delayed { border: 2px solid var(--critical); background: rgba(255, 49, 49, 0.05); }

        .reg-tag { color: var(--accent); font-weight: 800; font-size: 12px; display: block; }
        .duration-tag { font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 6px; background: rgba(255,255,255,0.05); }
        .delayed .duration-tag { color: var(--critical); background: rgba(255, 49, 49, 0.15); }

        .card-footer { display: flex; gap: 8px; margin-top: 15px; }
        .ctrl-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 8px; cursor: pointer; flex: 1; }
        .prio-toggle.active { color: var(--priority); border-color: var(--priority); text-shadow: 0 0 5px var(--priority); }

        #notesOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 1000; align-items: center; justify-content: center; }
        .modal { background: var(--glass); border: 1px solid var(--border); width: 380px; padding: 30px; border-radius: 24px; }
        .save-btn { background: var(--accent); color: black; border: none; padding: 12px; width: 100%; border-radius: 10px; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>

    <div id="notesOverlay">
        <div class="modal">
            <h2 id="mReg" style="margin:0; color:var(--accent);"></h2>
            <textarea id="nInput" placeholder="Add technical notes..." style="width:100%; height:100px; background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:12px; color:white; padding:12px; margin:15px 0; outline:none;"></textarea>
            <button class="save-btn" id="saveN">Save Note</button>
            <button onclick="closeN()" style="background:transparent; color:white; border:none; width:100%; margin-top:10px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div id="app">
        <div class="header">
            <div class="header-title">
                <h1>AutoCare Plus</h1>
                <span style="font-size:9px; color:var(--priority);">● NEON PRIORITY MODE ENABLED</span>
            </div>
            <input type="text" id="search" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); padding:10px; border-radius:10px; color:white; width:220px;" placeholder="Search Reg..." onkeyup="draw()">
        </div>

        <div class="workshop-floor">
            <div class="lane"><div class="lane-head" style="color:var(--new);">New Intake</div><div class="lane-body" id="lane-NEW"></div></div>
            <div class="lane"><div class="lane-head" style="color:var(--servicing);">Servicing</div><div class="lane-body" id="lane-SERVICING"></div></div>
            <div class="lane"><div class="lane-head" style="color:var(--ready);">Ready</div><div class="lane-body" id="lane-READY"></div></div>
            <div class="lane"><div class="lane-head" style="color:var(--collected);">Collected</div><div class="lane-body" id="lane-COLLECTED"></div></div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const db = getFirestore(initializeApp({
        apiKey: "AIzaSyD9cPmUCMEtT7XukcAxmeS50jKh1A2f31Q",
        projectId: "auto-care-plus-e7fdf"
    }));

    const STAGES = ["NEW", "SERVICING", "READY", "COLLECTED"];
    let data = [];
    let activeId = null;

    function getDuration(startTime) {
        if (!startTime) return { text: "0m", isDelayed: false };
        const diffMs = new Date() - startTime.toDate();
        const diffMins = Math.floor(diffMs / 60000);
        const hours = Math.floor(diffMins / 60);
        const mins = diffMins % 60;
        return {
            text: hours > 0 ? `${hours}h ${mins}m` : `${mins}m`,
            isDelayed: hours >= 6
        };
    }

    window.move = async (e, id, cur, dir) => {
        e.stopPropagation();
        const next = STAGES[STAGES.indexOf(cur) + dir];
        if (next) await updateDoc(doc(db, "jobs", id), { status: next });
    };

    window.setPriority = async (e, id, p) => {
        e.stopPropagation();
        await updateDoc(doc(db, "jobs", id), { isPriority: !p });
    };

    window.openN = (id, r, nt) => {
        activeId = id; document.getElementById('mReg').innerText = r;
        document.getElementById('nInput').value = nt || ""; document.getElementById('notesOverlay').style.display = 'flex';
    };

    window.closeN = () => document.getElementById('notesOverlay').style.display = 'none';

    document.getElementById('saveN').onclick = async () => {
        await updateDoc(doc(db, "jobs", activeId), { notes: document.getElementById('nInput').value });
        closeN();
    };

    function listen() {
        onSnapshot(query(collection(db, "jobs"), orderBy("createdAt", "desc")), (s) => {
            data = []; s.forEach(d => data.push({ id: d.id, ...d.data() }));
            draw();
        });
        setInterval(draw, 60000); // Refresh duration every minute
    }

    window.draw = () => {
        const q = document.getElementById('search').value.toLowerCase();
        STAGES.forEach(s => {
            const l = document.getElementById(`lane-${s}`); l.innerHTML = "";
            data.filter(j => (j.status || "NEW").toUpperCase() === s && (j.vehicleNumber || "").toLowerCase().includes(q))
                .sort((a,b) => (b.isPriority ? 1 : 0) - (a.isPriority ? 1 : 0)).forEach(job => {
                
                const dur = getDuration(job.createdAt);
                const c = document.createElement('div');
                c.className = `vehicle-card ${job.isPriority ? 'high-prio' : ''} ${dur.isDelayed ? 'delayed' : ''}`;
                c.onclick = () => openN(job.id, job.vehicleNumber, job.notes);
                c.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                        <span class="reg-tag">REG: ${job.vehicleNumber}</span>
                        <span class="duration-tag">${dur.text}</span>
                    </div>
                    <h3 style="margin:0; font-size:18px;">${job.customerName}</h3>
                    <div style="font-size:11px; opacity:0.6; margin-top:5px;">${job.serviceType}</div>
                    
                    <div class="card-footer">
                        <button class="ctrl-btn" onclick="move(event, '${job.id}', '${s}', -1)" ${s==='NEW'?'disabled':''}>←</button>
                        <button class="ctrl-btn prio-toggle ${job.isPriority ? 'active' : ''}" onclick="setPriority(event, '${job.id}', ${job.isPriority || false})">★</button>
                        <button class="ctrl-btn" onclick="move(event, '${job.id}', '${s}', 1)" ${s==='COLLECTED'?'disabled':''}>→</button>
                    </div>
                `;
                l.appendChild(c);
            });
        });
    }

    listen();
</script>
</body>
</html>
