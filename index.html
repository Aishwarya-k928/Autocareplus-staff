<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AutoCare Plus | Staff Command</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #00d2ff;
            --glass: rgba(10, 15, 28, 0.96);
            --border: rgba(255, 255, 255, 0.12);
            --bg: #020617;
            --new: #3b82f6;
            --servicing: #f59e0b;
            --ready: #10b981;
            --collected: #64748b;
        }

        body { margin: 0; background: var(--bg); color: white; font-family: 'Plus Jakarta Sans', sans-serif; }
        
        /* --- HEADER & NAVIGATION --- */
        .top-bar { 
            padding: 20px 40px; border-bottom: 1px solid var(--border); 
            background: rgba(2, 6, 23, 0.8); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }

        .search-box {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            padding: 10px 20px; border-radius: 12px; color: white; width: 300px; outline: none;
        }

        .tab-bar { display: flex; gap: 15px; margin-top: 15px; padding: 0 40px; }
        .tab { padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 800; font-size: 11px; color: #94a3b8; border: 1px solid transparent; }
        .tab.active { background: var(--accent); color: #020617; }

        /* --- CONTENT --- */
        .content-section { display: none; padding: 30px 40px; }
        .content-section.active { display: block; }
        .board-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }

        /* --- JOB CARDS --- */
        .job-card { 
            background: var(--glass); border: 1px solid var(--border); border-radius: 20px; 
            padding: 20px; transition: 0.3s;
        }
        .badge { font-size: 9px; font-weight: 800; padding: 4px 10px; border-radius: 50px; text-transform: uppercase; border: 1px solid; }
        .status-new { color: var(--new); }
        .status-servicing { color: var(--servicing); }
        .status-ready { color: var(--ready); }
        .status-collected { color: var(--collected); }

        /* --- CONTROLS --- */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .nav-btn { 
            padding: 12px; border-radius: 10px; border: 1px solid var(--border); 
            background: rgba(255,255,255,0.03); color: white; font-weight: 800; font-size: 10px; cursor: pointer; 
        }
        .nav-btn:hover:not(:disabled) { background: white; color: black; }
        .nav-btn:disabled { opacity: 0.1; cursor: not-allowed; }

        #loginOverlay { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div style="text-align:center; background:var(--glass); padding:40px; border-radius:28px; border: 1px solid var(--border); width: 350px;">
            <h2>Staff Portal</h2>
            <input type="password" id="password" placeholder="Terminal Key" style="width:100%; padding:15px; margin-bottom:15px; border-radius:10px; border:none; background:rgba(255,255,255,0.1); color:white;">
            <button onclick="attemptLogin()" style="width:100%; padding:15px; background:var(--accent); border:none; border-radius:10px; font-weight:800; cursor:pointer;">Enter Workshop</button>
        </div>
    </div>

    <div id="mainUI" style="display:none;">
        <div class="top-bar">
            <div>
                <h1 style="margin:0; font-size:18px;">Workshop Terminal</h1>
                <span style="font-size:9px; color:var(--ready);">● LIVE SYNC ACTIVE</span>
            </div>
            <input type="text" id="searchInput" class="search-box" placeholder="Search Reg or Name..." onkeyup="filterJobs()">
        </div>

        <div class="tab-bar">
            <div class="tab active" onclick="switchTab('active', event)">ACTIVE WORKFLOW</div>
            <div class="tab" onclick="switchTab('archive', event)">HISTORY (COLLECTED)</div>
        </div>

        <div id="activeSection" class="content-section active">
            <div class="board-grid" id="activeBoard"></div>
        </div>

        <div id="archiveSection" class="content-section">
            <div class="board-grid" id="archiveBoard"></div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const db = getFirestore(initializeApp({
        apiKey: "AIzaSyD9cPmUCMEtT7XukcAxmeS50jKh1A2f31Q",
        projectId: "auto-care-plus-e7fdf"
    }));

    const STAGES = ["NEW", "SERVICING", "READY", "COLLECTED"];
    let allJobs = [];

    window.switchTab = (type, e) => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        e.target.classList.add('active');
        document.getElementById(type + 'Section').classList.add('active');
    };

    window.moveStatus = async (jobId, current, direction) => {
        const idx = STAGES.indexOf(current);
        const nextIdx = idx + direction;
        if (nextIdx >= 0 && nextIdx < STAGES.length) {
            await updateDoc(doc(db, "jobs", jobId), { status: STAGES[nextIdx] });
        }
    };

    window.filterJobs = () => {
        const queryText = document.getElementById('searchInput').value.toLowerCase();
        renderBoards(queryText);
    };

    window.attemptLogin = async () => {
        const pass = document.getElementById('password').value;
        const target = localStorage.getItem('staffHash') || "a60965e69e46950275817d7b278156172551a1334f1989025176b1b70951a592";
        const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pass));
        const hex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');

        if (hex === target) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainUI').style.display = 'block';
            startListening();
        }
    };

    function startListening() {
        onSnapshot(query(collection(db, "jobs"), orderBy("createdAt", "desc")), (snap) => {
            allJobs = [];
            snap.forEach(d => allJobs.push({ id: d.id, ...d.data() }));
            renderBoards();
        });
    }

    function renderBoards(filter = "") {
        const active = document.getElementById('activeBoard');
        const archive = document.getElementById('archiveBoard');
        active.innerHTML = ""; archive.innerHTML = "";

        allJobs.forEach(job => {
            const status = (job.status || "NEW").toUpperCase();
            const searchable = `${job.customerName} ${job.vehicleNumber}`.toLowerCase();
            
            if (filter && !searchable.includes(filter)) return;
            if (!STAGES.includes(status)) return;

            const card = document.createElement('div');
            card.className = 'job-card';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <span class="badge status-${status.toLowerCase()}">${status}</span>
                    <b style="color:var(--accent); font-size:12px;">${job.vehicleNumber || '---'}</b>
                </div>
                <h3 style="margin:0; font-size:18px;">${job.customerName || 'N/A'}</h3>
                <p style="font-size:12px; opacity:0.6; margin:8px 0;">Task: ${job.serviceType || 'General'}</p>
                
                <div class="btn-group">
                    <button class="nav-btn" onclick="moveStatus('${job.id}', '${status}', -1)" ${status === 'NEW' ? 'disabled' : ''}>← Back</button>
                    <button class="nav-btn" onclick="moveStatus('${job.id}', '${status}', 1)" ${status === 'COLLECTED' ? 'disabled' : ''}>Next →</button>
                </div>
            `;

            if (status === "COLLECTED") archive.appendChild(card);
            else active.appendChild(card);
        });
    }
</script>
</body>
</html>
